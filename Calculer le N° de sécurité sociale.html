<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calcul cl√© du num√©ro de S√©curit√© Sociale</title>
<link rel="icon" type="image/png" href="carte-vitale.PNG" />
<style>
body {
    font-family: Arial, sans-serif;
    margin: 2rem;
    color: #111;
    background-image: url('mur.jpg');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
}

/* Titres et champs */
h1 { color: #ffffff; }
fieldset {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 1rem;
    background: white;
    margin-top: 1rem;
    max-width: 480px;
}
legend {
    font-weight: bold;
    color: #003366;
    padding-top: 3rem;
}
label { display: block; margin-top: 0.6rem; }
input, select {
    padding: 0.4rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    width: auto;
    min-width: 120px;
    max-width: 250px;
    box-sizing: border-box;
}
select#sexe { background: #3aa956; color: white; font-weight: bold; }
button {
    padding: 0.5rem 1rem;
    border: none;
    color: white;
    border-radius: 6px;
    cursor: pointer;
}
button[type="submit"] { background: #0077cc; }
button[type="submit"]:hover { background: #005fa3; }
button[type="reset"] { background: #888; }
#error { color: #b00020; margin-top: 0.5rem; }

#resultat {
    margin-top: 1rem;
    padding: 1rem;
    background: #eef6ff;
    border: 1px solid #cce0ff;
    border-radius: 8px;
    max-width: 480px;
}
.copy-btn { margin-left: 0.5rem; background: #555; }
.copied { color: green; margin-left: 0.5rem; }
.flex { display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; }

/* === Container layout === */
.container { display: flex; flex-direction: column; gap: 1rem; }

/* Aside styl√© et scrollable */
aside {
    background: #fff8d5;
    border-left: 5px solid #ffcc00;
    padding: 1.5rem 2rem;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    max-height: 300px;
    overflow-y: auto;
}

/* Version desktop : aside fixe √† droite */
@media(min-width: 768px) {
    .container { flex-direction: row; align-items: flex-start; }
    form { flex: 1; margin-right: 320px; }
    aside {
        position: fixed;
        right: 2rem;
        top: 12rem;
        width: 300px;
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
        order: 2;
    }
}

/* Suggestions autocomplete */
ul#suggestions {
    list-style: none;
    padding: 0;
    margin: 0;
    border: 1px solid #ccc;
    max-width: 300px;
    background: #fff;
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
    position: absolute;
}
ul#suggestions li { padding: 5px; cursor: pointer; }
ul#suggestions li.highlight { background-color: #eee; }
mark { background-color: yellow; font-weight: bold; }
</style>
</head>
<body>

<h1>
Calcul cl√© num√©ro s√©cu - by Ghost <span style="font-size:1.2em; margin-left:0.5em;">üí•</span>
<img src="carte-vitale.png" alt="Carte Vitale" style="height:1.5em; vertical-align:middle; border-radius:6px; margin-left:0.5em;">
</h1>

<div class="container">
<aside>
<strong>Mode d‚Äôemploi du calculateur:</strong>
<p>Pour calculer une cl√© de s√©curit√© sociale facilement, renseignez :</p>
<ul>
<li><b>Le sexe</b> (1 pour les hommes ; 2 pour les femmes) ;</li>
<li><b>L‚Äôann√©e de naissance</b> (si vous √™tes n√© en 1970, tapez 70) ;</li>
<li><b>Le mois de naissance</b> (janvier = 01, f√©vrier = 02, etc.) ;</li>
<li><b>Le num√©ro du d√©partement de naissance</b> (Paris = 75‚Ä¶). Les ressortissants √©trangers 99 ;</li>
<li><b>Le code de la commune de naissance</b> (code officiel INSEE sur 3 chiffres) ;</li>
<li><b>Le num√©ro d‚Äôordre de naissance</b> qui distingue les individus n√©s dans la m√™me localit√© et √† la m√™me date.</li>
</ul>
</aside>

<form id="formCleSecu" onsubmit="event.preventDefault(); calculerCle();">
<fieldset>
<legend>Informations personnelles</legend>

<label>Sexe :
<select id="sexe" required>
<option value="">S√©lectionnez</option>
<option value="1">1 - Homme</option>
<option value="2">2 - Femme</option>
</select>
</label>

<label>Ann√©e de naissance : <select id="annee" required></select></label>
<label>Mois de naissance : <select id="mois" required></select></label>
<label>D√©partement de naissance : <select id="dep" required></select></label>

<h2>Recherche ville / code postal</h2>
<input type="text" id="villeInput" placeholder="Tapez une ville ou un code postal" autocomplete="off" disabled>
<ul id="suggestions"></ul>

<label>Code commune (3 chiffres) : <input id="commune" type="text" maxlength="3" placeholder="CCC" required></label>
<label>Num√©ro d‚Äôordre (3 chiffres) : <input id="ordre" type="text" maxlength="3" placeholder="NNN" required></label>

<div style="margin-top:1rem;">
<button type="submit" style="font-weight:bold;">Calculer la cl√©</button>
<button type="reset" style="font-weight:bold;">Effacer</button>
</div>

<div id="msgErreur" class="error"></div>
</fieldset>
</form>
</div>

<div id="resultat" style="display:none;">
<h3 style="color:#009739; font-weight:bold;">‚úîÔ∏è N¬∞ s√©curit√© sociale pr√™t √† √™tre copi√©!</h3>
<div class="flex">
<input id="numComplet" type="text" readonly style="font-weight:bold; font-size:1rem; width:22rem;">
<button id="copier" class="copy-btn">Copier</button>
<span id="copiedMsg" class="copied" style="display:none;">Copi√© ‚úÖ</span>
<p><strong>Num√©ro sans cl√© :</strong> <span id="numero13"></span></p>
<p><strong>Cl√© calcul√©e :</strong> <span id="cle"></span></p>
</div>
</div>

<script>
/* ==== Remplissage dynamique des listes ==== */
const moisSelect = document.getElementById("mois");
for(let i=1;i<=12;i++){
    const val = String(i).padStart(2,"0");
    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = val + " - " + new Date(2000,i-1).toLocaleString("fr-FR",{month:"long"});
    moisSelect.appendChild(opt);
}

const depSelect = document.getElementById("dep");
const deps=[];
for(let i=1;i<=95;i++) deps.push(String(i).padStart(2,"0"));
deps.push("2A","2B");
for(let i=971;i<=976;i++) deps.push(String(i));
for(const d of deps){
    const opt = document.createElement("option");
    opt.value=d;
    opt.textContent=d;
    depSelect.appendChild(opt);
}

const anneeSelect = document.getElementById("annee");
for(let y=2026;y>=1940;y--){
    const opt = document.createElement("option");
    opt.value = String(y).slice(-2);
    opt.textContent = y;
    anneeSelect.appendChild(opt);
}

/* Input chiffres uniquement */
["commune","ordre"].forEach(id=>{
    document.getElementById(id).addEventListener("input",e=>{
        e.target.value=e.target.value.replace(/\D/g,"");
    });
});

/* ==== Calcul cl√© ==== */
function calculerCle(){
    document.getElementById("msgErreur").textContent="";
    document.getElementById("copiedMsg").style.display="none";
    const sexe=document.getElementById("sexe").value;
    const annee=document.getElementById("annee").value.trim();
    const mois=document.getElementById("mois").value;
    const dep=document.getElementById("dep").value;
    const commune=document.getElementById("commune").value.trim();
    const ordre=document.getElementById("ordre").value.trim();

    if(!["1","2"].includes(sexe)) return erreur("Veuillez s√©lectionner le sexe.");
    if(!/^\d{2}$/.test(annee)) return erreur("L‚Äôann√©e doit comporter 2 chiffres.");
    if(!/^\d{3}$/.test(commune)) return erreur("Le code commune doit comporter 3 chiffres.");
    if(!/^\d{3}$/.test(ordre)) return erreur("Le num√©ro d‚Äôordre doit comporter 3 chiffres.");

    let depCalc = dep;
    if(dep==="2A") depCalc="19";
    else if(dep==="2B") depCalc="18";

    const numero13 = sexe+annee+mois+depCalc.padStart(2,"0")+commune+ordre;
    const cle = calculCle97(numero13);
    const numeroComplet = numero13 + String(cle).padStart(2,"0");

    document.getElementById("numero13").textContent=numero13;
    document.getElementById("cle").textContent=String(cle).padStart(2,"0");
    document.getElementById("numComplet").value=numeroComplet;
    document.getElementById("resultat").style.display="block";
}

function erreur(txt){
    document.getElementById("msgErreur").textContent=txt;
    document.getElementById("resultat").style.display="none";
}

function calculCle97(numStr){
    let reste=0;
    for(let i=0;i<numStr.length;i++){
        reste=(reste*10+parseInt(numStr[i],10))%97;
    }
    let cle=97-reste;
    if(cle===0) cle=97;
    return cle;
}

/* ==== Copie ==== */
document.getElementById("copier").addEventListener("click", async()=>{
    const val=document.getElementById("numComplet").value;
    try{
        await navigator.clipboard.writeText(val);
        const msg=document.getElementById("copiedMsg");
        msg.style.display="inline";
        setTimeout(()=>msg.style.display="none",2000);
    }catch(e){ alert("Copie manuelle : "+val); }
});

/* ==== Autocompl√©tion communes ==== */
let communes=[];
let indexNom={};
let indexCP={};
const input = document.getElementById('villeInput');
const suggestions = document.getElementById('suggestions');
let selectedIndex=-1;

function buildIndex(){
    indexNom={}; indexCP={};
    for(const c of communes){
        const keyNom=c.nom.substring(0,3).toLowerCase();
        const keyCP=c.code_postal.substring(0,3);
        if(!indexNom[keyNom]) indexNom[keyNom]=[];
        indexNom[keyNom].push(c);
        if(!indexCP[keyCP]) indexCP[keyCP]=[];
        indexCP[keyCP].push(c);
    }
}

function search(query){
    query=query.toLowerCase();
    let results=[];
    if(query.length>=3){
        const key=query.substring(0,3);
        if(indexNom[key]) results=results.concat(indexNom[key].filter(c=>c.nom.toLowerCase().includes(query)));
    }
    if(/^\d{1,5}$/.test(query)){
        const key=query.substring(0,3);
        if(indexCP[key]) results=results.concat(indexCP[key].filter(c=>c.code_postal.includes(query)));
    }
    return results.slice(0,25);
}

function showSuggestions(list){
    suggestions.innerHTML=""; selectedIndex=-1;
    list.forEach(c=>{
        const li=document.createElement('li');
        li.textContent=c.nom+" ("+c.code_postal+")";
        li.dataset.code=c.code_insee;
        li.addEventListener("click",()=>selectCommune(c));
        suggestions.appendChild(li);
    });
}

function selectCommune(c){
    document.getElementById("villeInput").value=c.nom+" ("+c.code_postal+")";
    document.getElementById('commune').value = String(c.code_insee).slice(-3);
    suggestions.innerHTML="";
}

async function loadCommunes(){
    try{
        const resp=await fetch("communes.json");
        communes=await resp.json();
        buildIndex();
        input.disabled=false;
    }catch(e){ console.error("Impossible de charger le fichier JSON",e); }
}

input.addEventListener("input",e=>{
    const val=e.target.value;
    if(val.length<2){ suggestions.innerHTML=""; return; }
    const res=search(val);
    showSuggestions(res);
});

loadCommunes();
</script>
</body>
</html>
